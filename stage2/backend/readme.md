# API Менеджера Задач (Бэкенд)

Данный проект реализует бэкенд API для простого веб-приложения "Список задач". Он позволяет пользователям регистрироваться, проходить аутентификацию с использованием JWT токенов и управлять своими задачами через набор RESTful эндпоинтов.

Проект разработан на основе фреймворка FastAPI на Python и использует базу данных SQLite для постоянного хранения данных. Ограничение частоты запросов (rate limiting) реализовано с помощью FastAPI-Limiter с использованием Redis в качестве хранилища.

## Возможности

*   **Аутентификация пользователя:**
    *   Регистрация пользователя (`POST /register`).
    *   Генерация JWT access-токена после успешного входа (`POST /token`).
    *   Базовые заглушки для обновления токена (`POST /token/refresh`) и отзыва токена (`POST /token/revoke`), использующие хранение в памяти (с частичной настройкой инфраструктуры Redis).
*   **Управление задачами (CRUD):**
    *   Создание новой задачи (`POST /tasks/`).
    *   Получение списка всех задач (или отфильтрованных/отсортированных) для аутентифицированного пользователя (`GET /tasks/`).
    *   Обновление существующей задачи (`PUT /tasks/{task_id}`).
    *   Удаление задачи (`DELETE /tasks/{task_id}`).
*   **Модели данных:**
    *   Пользователи (email, хешированный пароль, статус активности).
    *   Задачи (заголовок, описание, статус выполнения, дата создания, владелец).
*   **Валидация и обработка ошибок:**
    *   Валидация входных данных с использованием Pydantic схем.
    *   Специализированные HTTP коды ошибок для неверных входных данных, ошибок аутентификации и т.д.
    *   Глобальный обработчик для непредвиденных ошибок.
*   **Безопасность:**
    *   Хеширование паролей с использованием bcrypt.
    *   JWT аутентификация с использованием Bearer-токенов.
    *   Ограничение частоты запросов на эндпоинтах регистрации и входа для защиты от перебора паролей (используя FastAPI-Limiter и Redis).
    *   Настроенное промежуточное ПО (middleware) для CORS.

## Используемые технологии

*   **Фреймворк:** FastAPI
*   **База данных:** SQLite (через SQLAlchemy)
*   **ORM:** SQLAlchemy
*   **Валидация данных:** Pydantic
*   **Аутентификация:** JWT (python-jose), Хеширование паролей (passlib с bcrypt)
*   **Ограничение частоты запросов:** FastAPI-Limiter
*   **Хранилище для Rate Limiting:** Redis
*   **Тестирование:** pytest, httpx, asgi-lifespan, pytest-asyncio

## Настройка и установка

Перед началом убедитесь, что у вас установлены:

*   Python 3.8+
*   pip (установщик пакетов Python)
*   Docker (для запуска Redis)

1.  **Перейдите в директорию с кодом бэкенда:**
    Убедитесь, что вы находитесь в папке, содержащей файлы `main.py`, `requirements.txt` и т.д.
    ```bash
    cd путь/к/вашему/коду/бэкенда
    ```

2.  **Создайте виртуальное окружение Python:**
    Настоятельно рекомендуется использовать виртуальное окружение для изоляции зависимостей проекта.
    ```bash
    python3 -m venv venv
    ```

3.  **Активируйте виртуальное окружение:**
    *   В macOS и Linux:
        ```bash
        source venv/bin/activate
        ```
    *   В Windows:
        ```bash
        venv\Scripts\activate
        ```

4.  **Установите зависимости:**
    Установите необходимые пакеты Python с помощью pip.
    ```bash
    pip install -r requirements.txt
    ```

5.  **Запустите Redis:**
    Приложение использует Redis для ограничения частоты запросов. Запустите Redis с использованием Docker.
    ```bash
    docker run -d --name task-manager-redis -p 6379:6379 redis:7
    ```
    *(Необязательно: Вы можете установить переменную окружения `REDIS_URL`, если Redis работает не на `redis://localhost:6379`, например: `export REDIS_URL="redis://<хост_redis>:<порт_redis>"`)*

6.  **Инициализация базы данных:**
    База данных SQLite (`./tasks.db`) будет автоматически создана, и необходимые таблицы (`users`, `tasks`) будут проинициализированы при первом запуске приложения.

## Запуск приложения

После завершения настройки и активации виртуального окружения:

1.  **Запустите сервер Uvicorn:**
    ```bash
    uvicorn main:app --reload
    ```
    Флаг `--reload` полезен при разработке, так как он заставляет сервер автоматически перезагружаться при изменениях в коде.

2.  API будет доступен по адресу `http://localhost:8000`.

3.  Вы можете получить доступ к интерактивной документации API по адресу `http://localhost:8000/docs` (Swagger UI) или `http://localhost:8000/redoc` (ReDoc).

## Эндпоинты API

Ниже приведен список доступных эндпоинтов:

### Аутентификация

*   **`POST /register`**
    *   **Описание:** Регистрирует нового пользователя.
    *   **Тело запроса:** JSON объект с полями `email` (строка) и `password` (строка).
    *   **Ответ:** `{"message": "User created successfully"}` при успехе (200), `{"detail": "Email already registered"}` при конфликте (400).
    *   **Ограничение частоты:** Да (5 запросов за 60 секунд).
*   **`POST /token`**
    *   **Описание:** Аутентифицирует пользователя и возвращает JWT access-токен.
    *   **Тело запроса:** Данные формы (`application/x-www-form-urlencoded`) с полями `username` (email пользователя) и `password`.
    *   **Ответ:** JSON объект с полями `access_token` (строка) и `token_type` (строка, "bearer") при успехе (200), `{"detail": "Incorrect username or password"}` при ошибке (401).
    *   **Ограничение частоты:** Да (10 запросов за 60 секунд).
*   **`POST /token/refresh`**
    *   **Описание:** Заглушка эндпоинта для обновления access-токена с использованием refresh-токена (в текущей реализации использует логику в памяти и возвращает placeholder access-токен).
    *   **Параметр запроса (Query Parameter):** `refresh_token` (строка).
    *   **Ответ:** JSON объект с полем `access_token` (строка) при успехе (200), `{"detail": "Token revoked"}` или другие 401 ошибки, если токен недействителен/отозван.
    *   **Ограничение частоты:** Да (10 запросов за 60 секунд).
*   **`POST /token/revoke`**
    *   **Описание:** Заглушка эндпоинта для отзыва токена (в текущей реализации использует логику в памяти).
    *   **Параметр запроса (Query Parameter):** `token` (строка).
    *   **Ответ:** `{"msg": "revoked"}` при успехе (200).

### Управление задачами (Требуется аутентификация)

Все эндпоинты управления задачами требуют наличия действительного JWT access-токена в заголовке `Authorization` в формате `Bearer <ваш_access_token>`.

*   **`GET /tasks/`**
    *   **Описание:** Получает список задач. Поддерживает фильтрацию и сортировку.
    *   **Параметры запроса (Query Parameters):**
        *   `skip` (целое, опционально, по умолчанию 0): Количество задач для пропуска.
        *   `limit` (целое, опционально, по умолчанию 100): Максимальное количество задач для возврата.
        *   `is_completed` (булево, опционально): Фильтрация по статусу выполнения.
        *   `sort_by` (строка, опционально, по умолчанию "created_at"): Поле для сортировки ("created_at" или "is_completed").
        *   `sort_order` (строка, опционально, по умолчанию "desc"): Порядок сортировки ("asc" или "desc").
    *   **Ответ:** JSON массив объектов Задач (см. `schemas.py` для структуры) при успехе (200), 401 при ошибке аутентификации.
    *   **Ограничение частоты:** Да (30 запросов за 60 секунд).
*   **`POST /tasks/`**
    *   **Описание:** Создает новую задачу для аутентифицированного пользователя.
    *   **Тело запроса:** JSON объект с полями `title` (строка, обязательно) и `description` (строка, опционально).
    *   **Ответ:** Созданный объект Задачи (см. `schemas.py`) при успехе (200), 401 при ошибке аутентификации.
    *   **Ограничение частоты:** Да (10 запросов за 60 секунд).
*   **`PUT /tasks/{task_id}`**
    *   **Описание:** Обновляет существующую задачу.
    *   **Параметр пути (Path Parameter):** `task_id` (целое, обязательно).
    *   **Тело запроса:** JSON объект с опциональными полями `title` (строка), `description` (строка), `is_completed` (булево). Предоставляйте только те поля, которые хотите обновить.
    *   **Ответ:** Обновленный объект Задачи (см. `schemas.py`) при успехе (200), 401 при ошибке аутентификации, 404 если задача не найдена.
*   **`DELETE /tasks/{task_id}`**
    *   **Описание:** Удаляет существующую задачу.
    *   **Параметр пути (Path Parameter):** `task_id` (целое, обязательно).
    *   **Ответ:** `{"message": "Task deleted successfully"}` при успехе (200), 401 при ошибке аутентификации, 404 если задача не найдена.

## Запуск тестов

Тесты написаны с использованием `pytest` и `httpx` и запускаются непосредственно против экземпляра приложения FastAPI без необходимости запускать отдельный сервер.

1.  **Активируйте виртуальное окружение** (если оно еще не активно).
2.  **Перейдите в директорию с кодом бэкенда.**
3.  **Запустите тесты:**
    *   В macOS и Linux:
        ```bash
        PYTHONPATH=$(pwd) pytest
        ```
    *   В Windows (PowerShell):
        ```powershell
        $env:PYTHONPATH = (Get-Location).Path; pytest
        ```
    *   В Windows (cmd.exe):
        ```cmd
        set PYTHONPATH=%cd%
        pytest
        ```

Тестовый набор включает один тестовый случай (`test_register_and_login`), который охватывает регистрацию пользователя, вход, получение access-токена, получение списка задач, создание задачи и базовые вызовы к эндпоинтам обновления/отзыва токенов.

## Структура проекта и детали реализации

*   **`main.py`:** Основной файл приложения FastAPI. Содержит определения роутов, внедрение зависимостей (`get_db`, `oauth2_scheme`), логику аутентификации и настройку ограничения частоты запросов. Включает базовые наборы в памяти для отозванных токенов и словарь для refresh-токенов (хотя эндпоинт обновления пока возвращает заглушку). Определены асинхронные функции для работы с Redis, но они не полностью интегрированы в текущие эндпоинты обновления/отзыва.
*   **`schemas.py`:** Определяет модели Pydantic, используемые для валидации и сериализации данных запросов и ответов.
*   **`models.py`:** Определяет ORM модели SQLAlchemy, которые сопоставляются с таблицами базы данных (`users`, `tasks`).
*   **`crud.py`:** Содержит вспомогательные функции CRUD (Create, Read, Update, Delete) для взаимодействия с базой данных через SQLAlchemy, включая хеширование паролей и логику аутентификации пользователя.
*   **`database.py`:** Настраивает движок SQLAlchemy и фабрику сессий. Сконфигурирован для SQLite.
*   **`requirements.txt`:** Перечисляет все зависимости Python.
*   **`test_main.py`:** Содержит тесты pytest для эндпоинтов API с использованием `httpx` и `asgi-lifespan`.

## Оценка по критериям

*   **Чистота и структура кода:** Проект следует стандартной многослойной архитектуре для приложений FastAPI, разделяя зоны ответственности между `main` (роуты/логика приложения), `crud` (операции с БД), `models` (схема БД) и `schemas` (валидация/сериализация данных). Импорты организованы, используется базовая типизация.
*   **Реализация аутентификации и защиты API:** Реализована JWT аутентификация с Bearer-токенами для защищенных роутов. Пароли хешируются. Введено базовое ограничение частоты запросов. Настроен CORS. Хотя эндпоинты обновления/отзыва существуют, их реализация пока является заглушкой, использующей наборы/словари в памяти; полная интеграция с определенными функциями Redis будет следующим шагом для повышения надежности. Для продакшена потребуются HTTPS и более продвинутые меры безопасности (например, защита от CSRF при использовании cookies, более строгая валидация ввода).
*   **Использование асинхронных операций и грамотная обработка ошибок:** FastAPI по своей природе асинхронен. Операции с базой данных с использованием SQLAlchemy являются синхронными в контексте `Depends(get_db)` (распространенный паттерн для SQLAlchemy ORM). Асинхронные операции корректно используются для клиента Redis и FastAPILimiter. Обработка ожидаемых API ошибок реализована через стандартные `HTTPException` FastAPI, а для более общих проблем есть глобальный обработчик исключений.
*   **Удобный и понятный интерфейс:** Для бэкенд API "интерфейсом" является сам API-контракт. Эндпоинты следуют принципам RESTful, используя стандартные HTTP методы. Схемы Pydantic предоставляют четкие структуры данных. Автоматически генерируемые `/docs` и `/redoc` предоставляют отличную документацию по API.
*   **Комментарии и документация к коду:** Файл `main.py` включает докстринги/комментарии для эндпоинтов, которые FastAPI использует для генерации документации OpenAPI. Встроенные комментарии не очень многочисленны, но структура кода направлена на читаемость.

